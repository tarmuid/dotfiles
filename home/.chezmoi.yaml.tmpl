{{- $ownershipChoices := list "personal" "work_flex" "work_strict" -}}
{{- $existingDefaults := (index . "defaults") | default dict -}}
{{- $existingPrograms := (index . "programs") | default dict -}}
{{- $existingOwnership := (index . "ownership") | default "" -}}
{{- $ownership := or (env "CHEZMOI_OWNERSHIP") $existingOwnership -}}
{{- if eq $ownership "" -}}
  {{- $ownership = promptChoiceOnce . "ownership" "Who owns this system" $ownershipChoices "personal" -}}
{{- end -}}

{{- if not (has $ownership $ownershipChoices) -}}
  {{- $ownership = "personal" -}}
{{- end -}}

{{- $profileChoices := list "portable" "rig" "server" -}}
{{- $existingProfile := (index . "profile") | default "" -}}
{{- $profile := or (env "CHEZMOI_PROFILE") $existingProfile -}}
{{- if eq $profile "" -}}
  {{- $profile = promptChoiceOnce . "profile" "Which system profile is this" $profileChoices "portable" -}}
{{- end -}}

{{- if not (has $profile $profileChoices) -}}
  {{- $profile = "portable" -}}
{{- end -}}

{{- $defaultCapacity := "development" -}}
{{- $isWorkOwned := or (eq $ownership "work_flex") (eq $ownership "work_strict") -}}

{{- $name := "" -}}
{{- $email := "" -}}
{{- if $isWorkOwned -}}
  {{- $name = or (env "WORK_NAME") (env "CHEZMOI_NAME") ((index . "name") | default "") -}}
  {{- $email = or (env "WORK_EMAIL") (env "CHEZMOI_EMAIL") ((index . "email") | default "") -}}
  {{- if eq $name "" -}}
    {{- $name = promptStringOnce . "name" "What is your work name" -}}
  {{- end -}}
  {{- if eq $email "" -}}
    {{- $email = promptStringOnce . "email" "What is your work email" -}}
  {{- end -}}
{{- else -}}
  {{- $name = or (env "CHEZMOI_NAME") ((index . "name") | default "") "tarmuid" -}}
  {{- $email = or (env "CHEZMOI_EMAIL") ((index . "email") | default "") "tarmuid@roslev.net" -}}
{{- end -}}

{{- $availableShells := list "zsh" "fish" "nushell" -}}
{{- $availableBrowsers := list "brave" "safari" -}}
{{- $availableTerminals := list "ghostty" "kitty" "alacritty" "wezterm" "iterm2" -}}
{{- $availableEditors := list "nvim" "vim" "emacs" "vscode" "zed" -}}
{{- $availablePasswordManagers := list "1password" "secretive" "bitwarden" "proton-pass" -}}
{{- $availableToolchains := list "mise" "go" "node" "python" "rust" -}}
{{- $capacityChoices := list "gaming" "development" "media" -}}

{{- /* default programs: single choice per category */ -}}
{{- $shell := "zsh" -}}
{{- $browser := or (env "CHEZMOI_DEFAULT_BROWSER") ((index $existingDefaults "browser") | default "") -}}
{{- if eq $browser "" -}}
  {{- $browser = promptChoiceOnce . "defaults.browser" "Default browser" $availableBrowsers "brave" -}}
{{- end -}}
{{- $terminal := or (env "CHEZMOI_DEFAULT_TERMINAL") ((index $existingDefaults "terminal") | default "") -}}
{{- if eq $terminal "" -}}
  {{- $terminal = promptChoiceOnce . "defaults.terminal" "Primary terminal" $availableTerminals "iterm2" -}}
{{- end -}}
{{- $editor := or (env "CHEZMOI_DEFAULT_EDITOR") ((index $existingDefaults "editor") | default "") -}}
{{- if eq $editor "" -}}
  {{- $editor = promptChoiceOnce . "defaults.editor" "Primary editor" $availableEditors "nvim" -}}
{{- end -}}
{{- $passwordManager := or (env "CHEZMOI_DEFAULT_PASSWORD_MANAGER") ((index $existingDefaults "password_manager") | default "") -}}
{{- if eq $passwordManager "" -}}
  {{- $passwordManager = promptChoiceOnce . "defaults.password_manager" "Primary password manager" $availablePasswordManagers "1password" -}}
{{- end -}}

{{- if not (has $browser $availableBrowsers) -}}
  {{- $browser = "brave" -}}
{{- end -}}
{{- if not (has $terminal $availableTerminals) -}}
  {{- $terminal = "iterm2" -}}
{{- end -}}
{{- if not (has $editor $availableEditors) -}}
  {{- $editor = "nvim" -}}
{{- end -}}
{{- if not (has $passwordManager $availablePasswordManagers) -}}
  {{- $passwordManager = "1password" -}}
{{- end -}}

{{- /* optional programs: multiple selections */ -}}
{{- $enabledCapacitiesRaw := (index . "capacities") | default (list) -}}
{{- if eq (len $enabledCapacitiesRaw) 0 -}}
  {{- $enabledCapacitiesRaw = promptMultichoiceOnce . "capacities" "Enable capacities" $capacityChoices (list $defaultCapacity) -}}
{{- end -}}
{{- $enabledCapacities := list -}}
{{- range $enabledCapacitiesRaw -}}
  {{- if has . $capacityChoices -}}
    {{- $enabledCapacities = append $enabledCapacities . -}}
  {{- end -}}
{{- end -}}
{{- if eq (len $enabledCapacities) 0 -}}
  {{- $enabledCapacities = list $defaultCapacity -}}
{{- end -}}
{{- $enabledShells := (index $existingPrograms "shells") | default (list) -}}
{{- if eq (len $enabledShells) 0 -}}
  {{- $enabledShells = promptMultichoiceOnce . "programs.shells" "Enable shells" $availableShells (list $shell) -}}
{{- end -}}
{{- $enabledPasswordManagers := (index $existingPrograms "password_managers") | default (list) -}}
{{- if eq (len $enabledPasswordManagers) 0 -}}
  {{- $enabledPasswordManagers = promptMultichoiceOnce . "programs.password_managers" "Enable password managers" $availablePasswordManagers (list $passwordManager) -}}
{{- end -}}
{{- $enabledTerminals := (index $existingPrograms "terminals") | default (list) -}}
{{- if eq (len $enabledTerminals) 0 -}}
  {{- $enabledTerminals = promptMultichoiceOnce . "programs.terminals" "Enable terminals" $availableTerminals (list $terminal) -}}
{{- end -}}
{{- $enabledEditors := (index $existingPrograms "editors") | default (list) -}}
{{- if eq (len $enabledEditors) 0 -}}
  {{- $enabledEditors = promptMultichoiceOnce . "programs.editors" "Enable editors" $availableEditors (list $editor) -}}
{{- end -}}
{{- $enabledToolchains := (index . "toolchains") | default (list) -}}
{{- if eq (len $enabledToolchains) 0 -}}
  {{- $enabledToolchains = promptMultichoiceOnce . "toolchains" "Enable language toolchains" $availableToolchains (list) -}}
{{- end -}}

{{- $xdgConfigHome := env "XDG_CONFIG_HOME" | default (printf "%s/.config" .chezmoi.homeDir) -}}
{{- $xdgCacheHome := env "XDG_CACHE_HOME" | default (printf "%s/.cache" .chezmoi.homeDir) -}}
{{- $xdgDataHome := env "XDG_DATA_HOME" | default (printf "%s/.local/share" .chezmoi.homeDir) -}}
{{- $xdgStateHome := env "XDG_STATE_HOME" | default (printf "%s/.local/state" .chezmoi.homeDir) -}}
{{- $xdgBinHome := env "XDG_BIN_HOME" | default (printf "%s/.local/bin" .chezmoi.homeDir) -}}

encryption: age
age:
  command: "rage"
  identity: {{ printf "%s/.config/chezmoi/key.txt" .chezmoi.homeDir | quote }}
  recipient: age10l3f3ldcx6s4jesnjmeksfuc086uftt732989np5vttg9nr8z5fsydymcx
# Disable interactive paging for chezmoi output so command results stay in terminal scrollback.
pager: {{ if lookPath "bat" }}"bat"{{ else }}"cat"{{ end }}
data:
  name: {{ $name | quote }}
  email: {{ $email | quote }}
  signing_key: "ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBBSCvAK0qU7SE790815rs/DCb3J6/TZXtZCn3KU6Qf5FEsYInhqyjuZJVp6I7cMLYIT6AVMgyZdtQ4phrNieqWE="
  ownership: {{ $ownership | quote }}
  profile: {{ $profile | quote }}
  capacities: {{ $enabledCapacities | toJson }}
  flags:
    is_work_owned: {{ $isWorkOwned }}
  defaults:
    shell: {{ $shell | quote }}
    browser: {{ $browser | quote }}
    terminal: {{ $terminal | quote }}
    editor: {{ $editor | quote }}
    password_manager: {{ $passwordManager | quote }}
{{- if eq .chezmoi.os "darwin" }}
  homebrew:
    prefix: "/opt/homebrew"
{{- end }}
  programs:
    password_managers: {{ $enabledPasswordManagers | toJson }}
    terminals: {{ $enabledTerminals | toJson }}
    editors: {{ $enabledEditors | toJson }}
    shells: {{ $enabledShells | toJson }}
  toolchains: {{ $enabledToolchains | toJson }}
  xdg:
    configHome: {{ $xdgConfigHome | quote }}
    cacheHome: {{ $xdgCacheHome | quote }}
    dataHome: {{ $xdgDataHome | quote }}
    stateHome: {{ $xdgStateHome | quote }}
    binHome: {{ $xdgBinHome | quote }}
    
