#!/bin/sh
set -eu

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
origin_url="$(git config --get remote.origin.url 2>/dev/null || true)"

is_work_repo=0
case "$repo_root/" in
  "$HOME/git/work/"*) is_work_repo=1 ;;
esac

# Keep work remote matching private by allowing a local-only regex env var.
if [ "$is_work_repo" -eq 0 ] && [ -n "${WORK_GIT_REMOTE_REGEX:-}" ] && printf '%s' "$origin_url" | grep -Eq "$WORK_GIT_REMOTE_REGEX"; then
  is_work_repo=1
fi

if [ "${GIT_SIGNING_AGENT:-}" = "work" ]; then
  is_work_repo=1
fi

if [ "${GIT_SIGNING_AGENT:-}" = "personal" ]; then
  is_work_repo=0
fi

if [ "$is_work_repo" -eq 0 ]; then
  sock="${SECRETIVE_SSH_AUTH_SOCK:-$HOME/Library/Containers/com.maxgoedjen.Secretive.SecretAgent/Data/socket.ssh}"
  if [ -S "$sock" ]; then
    export SSH_AUTH_SOCK="$sock"
  fi
fi

exec ssh-keygen "$@"
