#!/usr/bin/env zsh

set -euo pipefail

if [[ "{{ .chezmoi.os }}" != "darwin" ]]; then
  exit 0
fi

{{ $ownership := index . "ownership" | default "personal" -}}
{{ $isWorkOwned := or (eq $ownership "work_flex") (eq $ownership "work_strict") -}}
{{ $profile := index . "profile" | default "portable" -}}
{{ $capacities := index . "capacities" | default (list "development") -}}
{{ $programs := index . "programs" | default dict -}}
{{ $enabledPasswordManagers := index $programs "password_managers" | default list -}}
{{ $enabledTerminals := index $programs "terminals" | default list -}}
{{ $enabledEditors := index $programs "editors" | default list -}}
{{ $enabledShells := index $programs "shells" | default list -}}
{{ $enabledToolchains := index . "toolchains" | default list -}}
{{ $defaults := index . "defaults" | default dict -}}
{{ $defaultBrowser := index $defaults "browser" | default "" -}}

{{ $basePackages := index . "packages" | default dict -}}
{{ $baseBrewConfig := index $basePackages "brew" | default dict -}}
{{ $overlayBrewConfig := dict -}}
{{- if $isWorkOwned -}}
  {{- $overlayData := (include "../install/macos/work/packages.work.yaml.age" | decrypt | fromYaml) | default dict -}}
  {{- $overlayPackages := index $overlayData "packages" | default dict -}}
  {{- $overlayBrewConfig = index $overlayPackages "brew" | default dict -}}
{{- end -}}

{{ $selectedLayers := list -}}
{{ $brewConfigs := list $baseBrewConfig $overlayBrewConfig -}}
{{ range $brewConfig := $brewConfigs -}}
  {{ $selectedLayers = append $selectedLayers (index $brewConfig "base" | default dict) -}}

  {{ $ownershipLayers := index $brewConfig "ownership" | default dict -}}
  {{ $selectedLayers = append $selectedLayers (index $ownershipLayers $ownership | default dict) -}}

  {{ $profileLayers := index $brewConfig "profiles" | default dict -}}
  {{ $selectedLayers = append $selectedLayers (index $profileLayers $profile | default dict) -}}

  {{ $capacityLayers := index $brewConfig "capacities" | default dict -}}
  {{ range $capacity := $capacities -}}
    {{ $selectedLayers = append $selectedLayers (index $capacityLayers $capacity | default dict) -}}
  {{ end -}}

  {{ $programLayers := index $brewConfig "programs" | default dict -}}

  {{ $passwordManagerLayers := index $programLayers "password_managers" | default dict -}}
  {{ range $name := $enabledPasswordManagers -}}
    {{ $selectedLayers = append $selectedLayers (index $passwordManagerLayers $name | default dict) -}}
  {{ end -}}

  {{ $terminalLayers := index $programLayers "terminals" | default dict -}}
  {{ range $name := $enabledTerminals -}}
    {{ $selectedLayers = append $selectedLayers (index $terminalLayers $name | default dict) -}}
  {{ end -}}

  {{ $editorLayers := index $programLayers "editors" | default dict -}}
  {{ range $name := $enabledEditors -}}
    {{ $selectedLayers = append $selectedLayers (index $editorLayers $name | default dict) -}}
  {{ end -}}

  {{ $shellLayers := index $programLayers "shells" | default dict -}}
  {{ range $name := $enabledShells -}}
    {{ $selectedLayers = append $selectedLayers (index $shellLayers $name | default dict) -}}
  {{ end -}}

  {{ $toolchainLayers := index $programLayers "toolchains" | default dict -}}
  {{ range $name := $enabledToolchains -}}
    {{ $selectedLayers = append $selectedLayers (index $toolchainLayers $name | default dict) -}}
  {{ end -}}

  {{ $browserLayers := index $programLayers "browsers" | default dict -}}
  {{ if $defaultBrowser -}}
    {{ $selectedLayers = append $selectedLayers (index $browserLayers $defaultBrowser | default dict) -}}
  {{ end -}}
{{ end -}}

{{ $kinds := list "taps" "formulae" "casks" -}}
{{ $brewItems := dict "taps" (list) "formulae" (list) "casks" (list) -}}
{{ range $layer := $selectedLayers -}}
  {{ range $kind := $kinds -}}
    {{ $current := index $brewItems $kind | default list -}}
    {{ $next := index $layer $kind | default list -}}
    {{ $_ := set $brewItems $kind (concat $current $next) -}}
  {{ end -}}
{{ end -}}
{{ range $kind := $kinds -}}
  {{ $_ := set $brewItems $kind (uniq (index $brewItems $kind | default list)) -}}
{{ end -}}

BREW_BIN=""
if command -v brew >/dev/null 2>&1; then
  BREW_BIN="$(command -v brew)"
elif [[ -x "/opt/homebrew/bin/brew" ]]; then
  BREW_BIN="/opt/homebrew/bin/brew"
fi

if [[ -z "${BREW_BIN}" ]]; then
  echo "Homebrew is unavailable; skipping package sync." >&2
  exit 0
fi

BREWFILE_TMP="$(mktemp "${TMPDIR:-/tmp}/chezmoi-brewfile.XXXXXX")"
trap 'rm -f "${BREWFILE_TMP}"' EXIT

cat >"${BREWFILE_TMP}" <<'EOF_BREWFILE'
# ===== TAPS =====
{{ range (index $brewItems "taps") -}}
tap {{ . | quote }}
{{ end -}}

# ===== FORMULAE =====
{{ range (index $brewItems "formulae") -}}
brew {{ . | quote }}
{{ end -}}

# ===== CASKS =====
{{ range (index $brewItems "casks") -}}
cask {{ . | quote }}
{{ end -}}
EOF_BREWFILE

if [[ -z "$(tr -d '[:space:]' < "${BREWFILE_TMP}")" ]]; then
  echo "No Homebrew packages defined; skipping package sync."
  exit 0
fi

if "${BREW_BIN}" bundle check --file="${BREWFILE_TMP}" >/dev/null 2>&1; then
  echo "Homebrew bundle already satisfied."
  exit 0
fi

echo "Applying Homebrew bundle..."
"${BREW_BIN}" bundle install --file="${BREWFILE_TMP}" --no-upgrade

if [[ "${CHEZMOI_BREW_CLEANUP:-0}" == "1" ]]; then
  echo "Cleaning up unmanaged Homebrew packages..."
  "${BREW_BIN}" bundle cleanup --file="${BREWFILE_TMP}" --force
fi
