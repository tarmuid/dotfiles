#!/usr/bin/env zsh

set -euo pipefail

if [[ "{{ .chezmoi.os }}" != "darwin" ]]; then
  exit 0
fi

{{ $capacities := index . "capacities" | default (list "client") -}}
{{ $packages := index . "packages" | default dict -}}
{{ $darwin := index $packages "darwin" | default dict -}}
{{ $brew := index $darwin "brew" | default dict -}}
{{ $profiles := index $packages "profiles" | default dict -}}

{{ $profile := index . "profile" | default "home" -}}
{{ $profilePackages := index $profiles $profile | default dict -}}
{{ $profileDarwin := index $profilePackages "darwin" | default dict -}}
{{ $profileBrew := index $profileDarwin "brew" | default dict -}}

{{ $darwinCapacities := index $darwin "capacities" | default dict -}}
{{ $darwinPasswordManagers := index $darwin "password_managers" | default dict -}}
{{ $darwinTerminals := index $darwin "terminals" | default dict -}}
{{ $darwinEditors := index $darwin "editors" | default dict -}}
{{ $darwinShells := index $darwin "shells" | default dict -}}
{{ $darwinToolchains := index $darwin "toolchains" | default dict -}}
{{ $darwinBrowsers := index $darwin "browsers" | default dict -}}

{{ $programs := index . "programs" | default dict -}}
{{ $enabledPasswordManagers := index $programs "password_managers" | default list -}}
{{ $enabledTerminals := index $programs "terminals" | default list -}}
{{ $enabledEditors := index $programs "editors" | default list -}}
{{ $enabledShells := index $programs "shells" | default list -}}
{{ $enabledToolchains := index . "toolchains" | default list -}}
{{ $defaults := index . "defaults" | default dict -}}
{{ $defaultBrowser := index $defaults "browser" | default "" -}}

BREW_BIN=""
if command -v brew >/dev/null 2>&1; then
  BREW_BIN="$(command -v brew)"
elif [[ -x "/opt/homebrew/bin/brew" ]]; then
  BREW_BIN="/opt/homebrew/bin/brew"
fi

if [[ -z "${BREW_BIN}" ]]; then
  echo "Homebrew is unavailable; skipping package sync." >&2
  exit 0
fi

BREWFILE_TMP="$(mktemp "${TMPDIR:-/tmp}/chezmoi-brewfile.XXXXXX")"
trap 'rm -f "${BREWFILE_TMP}"' EXIT

cat >"${BREWFILE_TMP}" <<'EOF_BREWFILE'
{{ range (index $brew "taps") -}}
tap {{ . | quote }}
{{ end -}}
{{ range (index $profileBrew "taps") -}}
tap {{ . | quote }}
{{ end -}}
{{ range (index $brew "formulae") -}}
brew {{ . | quote }}
{{ end -}}
{{ range (index $profileBrew "formulae") -}}
brew {{ . | quote }}
{{ end -}}
{{ range (index $brew "casks") -}}
cask {{ . | quote }}
{{ end -}}
{{ range (index $profileBrew "casks") -}}
cask {{ . | quote }}
{{ end -}}
{{- /* Capacity-specific packages */ -}}
{{ range $capacities -}}
{{ $capPkgs := index $darwinCapacities . | default dict -}}
{{ $capBrew := index $capPkgs "brew" | default dict -}}
{{ range (index $capBrew "taps") -}}
tap {{ . | quote }}
{{ end -}}
{{ range (index $capBrew "formulae") -}}
brew {{ . | quote }}
{{ end -}}
{{ range (index $capBrew "casks") -}}
cask {{ . | quote }}
{{ end -}}
{{ end -}}
{{- /* Password manager packages */ -}}
{{ range $enabledPasswordManagers -}}
{{ $pmPkgs := index $darwinPasswordManagers . | default dict -}}
{{ $pmBrew := index $pmPkgs "brew" | default dict -}}
{{ range (index $pmBrew "taps") -}}
tap {{ . | quote }}
{{ end -}}
{{ range (index $pmBrew "formulae") -}}
brew {{ . | quote }}
{{ end -}}
{{ range (index $pmBrew "casks") -}}
cask {{ . | quote }}
{{ end -}}
{{ end -}}
{{- /* Terminal packages */ -}}
{{ range $enabledTerminals -}}
{{ $termPkgs := index $darwinTerminals . | default dict -}}
{{ $termBrew := index $termPkgs "brew" | default dict -}}
{{ range (index $termBrew "taps") -}}
tap {{ . | quote }}
{{ end -}}
{{ range (index $termBrew "formulae") -}}
brew {{ . | quote }}
{{ end -}}
{{ range (index $termBrew "casks") -}}
cask {{ . | quote }}
{{ end -}}
{{ end -}}
{{- /* Editor packages */ -}}
{{ range $enabledEditors -}}
{{ $edPkgs := index $darwinEditors . | default dict -}}
{{ $edBrew := index $edPkgs "brew" | default dict -}}
{{ range (index $edBrew "taps") -}}
tap {{ . | quote }}
{{ end -}}
{{ range (index $edBrew "formulae") -}}
brew {{ . | quote }}
{{ end -}}
{{ range (index $edBrew "casks") -}}
cask {{ . | quote }}
{{ end -}}
{{ end -}}
{{- /* Shell packages */ -}}
{{ range $enabledShells -}}
{{ $shPkgs := index $darwinShells . | default dict -}}
{{ $shBrew := index $shPkgs "brew" | default dict -}}
{{ range (index $shBrew "taps") -}}
tap {{ . | quote }}
{{ end -}}
{{ range (index $shBrew "formulae") -}}
brew {{ . | quote }}
{{ end -}}
{{ range (index $shBrew "casks") -}}
cask {{ . | quote }}
{{ end -}}
{{ end -}}
{{- /* Toolchain packages */ -}}
{{ range $enabledToolchains -}}
{{ $tcPkgs := index $darwinToolchains . | default dict -}}
{{ $tcBrew := index $tcPkgs "brew" | default dict -}}
{{ range (index $tcBrew "taps") -}}
tap {{ . | quote }}
{{ end -}}
{{ range (index $tcBrew "formulae") -}}
brew {{ . | quote }}
{{ end -}}
{{ range (index $tcBrew "casks") -}}
cask {{ . | quote }}
{{ end -}}
{{ end -}}
{{- /* Default browser package */ -}}
{{ if $defaultBrowser -}}
{{ $brPkgs := index $darwinBrowsers $defaultBrowser | default dict -}}
{{ $brBrew := index $brPkgs "brew" | default dict -}}
{{ range (index $brBrew "taps") -}}
tap {{ . | quote }}
{{ end -}}
{{ range (index $brBrew "formulae") -}}
brew {{ . | quote }}
{{ end -}}
{{ range (index $brBrew "casks") -}}
cask {{ . | quote }}
{{ end -}}
{{ end -}}
EOF_BREWFILE

if [[ -z "$(tr -d '[:space:]' < "${BREWFILE_TMP}")" ]]; then
  echo "No Homebrew packages defined; skipping package sync."
  exit 0
fi

if "${BREW_BIN}" bundle check --file="${BREWFILE_TMP}" >/dev/null 2>&1; then
  echo "Homebrew bundle already satisfied."
  exit 0
fi

echo "Applying Homebrew bundle..."
"${BREW_BIN}" bundle install --file="${BREWFILE_TMP}" --no-upgrade

if [[ "${CHEZMOI_BREW_CLEANUP:-0}" == "1" ]]; then
  echo "Cleaning up unmanaged Homebrew packages..."
  "${BREW_BIN}" bundle cleanup --file="${BREWFILE_TMP}" --force
fi
